---
layout: post
title: Dynamically add data accessor methods on "static" Rails data model
tags:
- Rails
- Ruby
status: publish
type: post
published: true
meta:
  _edit_last: '544375'
  jabber_published: '1299951669'
  email_notification: '1299951671'
---
An useful metaprogramming spell I recently played with is the <code>Module#define_method()</code>, which dynamically adds an instance method to the class on which is called.

&nbsp;

I found it particularly useful to add data accessor methods on "static" Rails data model: suppose I'm working an e-commerce Rails webapp, and I have a <code>Country</code> model which maps the countries suitable for shipping, or a <code>PaymentType</code> model which represents all the possible payment types.

For these kind of models (and tables), which are typically static (they don't change often), you often have to access specific values, say <code>Country.italy</code> or <code>PaymentType.credit_card</code>.

In these cases, defining dynamically an accessor method may be useful and more clear than always perform a <code>find_by_name("my value")</code>.

So, for example, I open up my country.rb model class and add these lines

[sourcecode language="ruby"]
class &lt;&lt; self
  Country.all.each do |each_country|
    define_method(each_country.name.downcase.gsub('.', '').gsub(' ', '_')) do
      Country.find_by_iso_code(each_country.iso_code)
    end
  end
end
[/sourcecode]
And then opening the Rails console I will be able to type
<pre>1.8.7@epistore &gt; Country.sri_lanka
# {
                :id =&gt; 59,
              :zone =&gt; "U9",
           :enabled =&gt; true,
        :created_at =&gt; Tue, 20 Apr 2010 17:01:45 CEST +02:00,
        :updated_at =&gt; Tue, 20 Apr 2010 17:01:45 CEST +02:00,
          :iso_code =&gt; "LK",
    :country_set_id =&gt; nil
}</pre>
Just a note: as I said, <code>Module#define_method()</code> will add an <strong>instance method on the class</strong>. To add a <strong>class method</strong>, which is what I want, we have to use a different approach, using the <code>class &lt;&lt; self</code> syntax to add a singleton method in the receiver.

I may also add a query method on each <code>Country</code> instance to check that country against another country (for example, I may ask <code>my_country.italy?</code>)
<pre>  Country.all.each do |each_country|
    define_method(each_country.name.downcase.gsub('.', '').gsub(' ', '_').concat('?')) do
      has_iso_code? each_country.iso_code
    end
  end</pre>
And then, after issuing a <code>reload!</code> command in the Rails console, I may type:
<pre>1.8.7@epistore &gt; Country.usa.usa?
true
1.8.7@epistore &gt; Country.usa.italy?
false
1.8.7@epistore &gt; Country.usa.south_korea?
false
1.8.7@epistore &gt; Country.south_korea.south_korea?
true</pre>
Depending on the kind of Rails app you have, these may be a useful tip.
